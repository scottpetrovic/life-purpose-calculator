<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two-Phase Retirement Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        * {
            font-size: 13px;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1400px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .small-notes {
            font-size: 11px;
            color: grey;
        }

        h1, h2 {
            color: #333;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #ddd;
            border: none;
            outline: none;
        }
        .tab.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
            gap: 20px;
            flex-wrap: nowrap;
        }
        .tab-content.active {
            display: flex;
        }
        .input-section {
            background: #e2f6ff;
            padding: 1rem;
        }
        .results-section {
            flex: 2;
            min-width: 300px;
        }
        form {
            display: grid;
            gap: 10px;
        }
        label {

        }
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        #results {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .parameter-input-container {
            display: flex;
            flex-direction: column;
            row-gap: 5px;
            /* border: 1px solid #ddd; */
            border-radius: 4px;
            padding: 1rem;
            background: white;
        }
        .dollar-sign {
            color: #333;
        }
        .parameter-input-container input {
            padding: 12px;
            background: #f3f3f3;
            border: 0;
            box-sizing: border-box;
        }
        .parameter-input-container input:focus {
            outline: none;
        }
        #retirementTable th, #retirementTable td {
            text-align: right;
        }
        .expense-header, .expense-column {
            background-color: #ffeaea;
        }
        .income-header, .income-column {
            background-color: #d8ffd8;
        }
        .balance-header, .balance-column {
            background-color: #ecf5ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Two-Phase Retirement Calculator</h1>
        <p><em>Note: Tax brackets are estimated based on 2023 data with an annual adjustment for inflation.</em></p>

        <div class="tabs">
            <button class="tab active" onclick="openTab(event, 'accumulation')">Accumulation Phase</button>
            <button class="tab" onclick="openTab(event, 'distribution')">Distribution Phase</button>
        </div>

        <div id="accumulation" class="tab-content active">
            <div class="input-section">
                <form id="accumulationForm">
                    <div class="parameter-input-container">
                        <label for="currentAge">Current Age</label>
                        <input type="number" id="currentAge" value="35" required>
                    </div>
                    <div class="parameter-input-container">
                        <label for="annualIncome">Annual Pre-tax Income</label>
                        <span>
                            <span class="dollar-sign">$</span>
                            <input type="text" id="annualIncome" value="60000" required>
                        </span>
                    </div>
                    <div class="parameter-input-container">
                        <label for="currentSavings">Current Retirement Savings</label>
                        <span>
                            <span class="dollar-sign">$</span>
                            <input type="text" id="currentSavings" value="30000" required>
                        </span>
                    </div>
                    <div class="parameter-input-container">
                        <label for="monthlyContributions">Monthly Investment Contribution</label>
                        <span>
                            <span class="dollar-sign">$</span>
                            <input type="text" id="monthlyContributions" value="500" required>
                        </span>
                    </div>

                    <div class="parameter-input-container">
                        <label for="currentMonthlyExpenses">Current Monthly Expenses</label>
                        <span>
                            <span class="dollar-sign">$</span>
                            <input type="text" id="currentMonthlyExpenses" value="2000" required>
                        </span>
                        <span id="monthlyExpensesAtRetirement" class="small-notes"></span>
                    </div>

                    <div class="parameter-input-container">
                        <label for="retirementAge">Retirement Age</label>
                        <input type="number" id="retirementAge" value="67">
                    </div>
                    <div class="parameter-input-container">
                        <label for="preReturnRate">Pre-retirement Rate of Return (%)</label>
                        <input type="number" id="preReturnRate" value="6" step="0.1">
                    </div>
                    <div class="parameter-input-container">
                        <label for="inflationRate">Inflation Rate (%)</label>
                        <input type="number" id="inflationRate" value="3" step="0.1">
                    </div>
                    <div class="parameter-input-container">
                        <label for="incomeIncrease">Annual Income Increase (%)</label>
                        <input type="number" id="incomeIncrease" value="2" step="0.1">
                    </div>
                    <button type="submit">Calculate Accumulation Phase</button>
                </form>
            </div>
            <div class="results-section">
                
                <div id="accumulationResults">
                    <canvas id="accumulationChart"></canvas>
                    <table id="accumulationTable">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Age</th>
                                <th>Annual Income</th>
                                <th>Contributions</th>
                                <th>Investment Returns</th>
                                <th>Total Savings</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="distribution" class="tab-content">
            <div class="input-section">
                <form id="distributionForm">
                    <div class="parameter-input-container">
                        <label for="retirementSavings">Starting Retirement Amount</label>
                        <span>
                            <span class="dollar-sign">$</span>
                            <input type="text" style="opacity: 0.5" id="retirementSavings" required disabled>
                        </span>
                    </div>

                    <div class="parameter-input-container">
                        <label for="monthlySocialSecurity">Monthly Social Security Benefit</label>
                        <span>
                            <span class="dollar-sign">$</span>
                            <input type="text" id="monthlySocialSecurity" value="1500" required>
                        </span>
                    </div>
                    <div class="parameter-input-container">
                        <label for="otherIncome">Other Monthly Retirement Income</label>
                        <span>
                            <span class="dollar-sign">$</span>
                            <input type="text" id="otherIncome" value="0" required>
                        </span>
                    </div>
                    <div class="parameter-input-container">
                        <label for="lifeExpectancy">Life Expectancy</label>
                        <input type="number" id="lifeExpectancy" value="95">
                    </div>
                    <div class="parameter-input-container">
                        <label for="postReturnRate">Post-retirement Rate of Return (%)</label>
                        <input type="number" id="postReturnRate" value="5" step="0.1">
                    </div>
                    <div class="parameter-input-container">
                        <label for="inflationRateDistribution">Inflation Rate (%)</label>
                        <input type="number" id="inflationRateDistribution" value="3" step="0.1">
                    </div>
                    <button type="submit">Calculate Distribution Phase</button>
                </form>
            </div>
            <div class="results-section">
                <div id="distributionResults">
                    <canvas id="distributionChart"></canvas>
                    <table id="distributionTable">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Age</th>
                                <th>Expenses</th>
                                <th>Social Security</th>
                                <th>Other Income</th>
                                <th>Withdrawal</th>
                                <th>Remaining Savings</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ... (Keep your existing JavaScript code here, we'll add new functions below)

        var projectedMonthlyExpensesAtRetirement

        function openTab(evt, tabName) {
            var i, tabContent, tabLinks;
            tabContent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabContent.length; i++) {
                tabContent[i].style.display = "none";
            }
            tabLinks = document.getElementsByClassName("tab");
            for (i = 0; i < tabLinks.length; i++) {
                tabLinks[i].className = tabLinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "flex";
            evt.currentTarget.className += " active";

            // Calculate distribution phase when switching to the distribution tab
            if (tabName === 'distribution') {
                calculateDistributionPhase();
            }
        }

    function calculateAccumulationPhase() {
        const inputs = getAccumulationInputValues();
        const accumulationData = [];
        let currentValues = {
            savings: inputs.currentSavings,
            income: inputs.annualIncome,
            contributions: inputs.monthlyContributions * 12,
            currentYear: new Date().getFullYear()
        };

        for (let age = inputs.currentAge; age <= inputs.retirementAge; age++) {
            const yearData = calculateAccumulationYearlyData(age, inputs, currentValues);
            accumulationData.push(yearData);
            
            currentValues = {
                savings: yearData.endAmount,
                income: yearData.income,
                contributions: yearData.contributions,
                currentYear: yearData.year + 1
            };
        }

        // calculate the estimaged living expenses when the person retires
        const yearsUntilRetirement = inputs.retirementAge - inputs.currentAge;
        
        projectedMonthlyExpensesAtRetirement = inputs.currentMonthlyExpenses * Math.pow(1 + inputs.inflationRate, yearsUntilRetirement);
        document.getElementById('monthlyExpensesAtRetirement').innerHTML = 
            `${ currencyFormatter.format(projectedMonthlyExpensesAtRetirement) } monthly expenses at retirement `;
        document.getElementById('monthlyExpensesAtRetirement').value = projectedMonthlyExpensesAtRetirement
        

        updateAccumulationChart(accumulationData);
        updateAccumulationTable(accumulationData);
        document.getElementById('retirementSavings').value = Math.round(accumulationData[accumulationData.length - 1].endAmount).toLocaleString('en-US');
    }

        function calculateDistributionPhase() {


        const inputs = getDistributionInputValues();
        const distributionData = [];


        let currentValues = {
            savings: inputs.retirementSavings,
            age: inputs.retirementAge,
            currentYear: new Date().getFullYear() + (inputs.retirementAge - getAccumulationInputValues().currentAge)
        };

        for (let age = inputs.retirementAge; age <= inputs.lifeExpectancy; age++) {
            const yearData = calculateDistributionYearlyData(age, inputs, currentValues);
            distributionData.push(yearData);
            
            currentValues = {
                savings: yearData.remainingSavings,
                age: age + 1,
                currentYear: yearData.year + 1
            };

            if (yearData.remainingSavings <= 0) {
                console.log(`Retirement savings depleted at age ${age}`);
                break;
            }
        }

        updateDistributionChart(distributionData);
        updateDistributionTable(distributionData);
    }

        function getAccumulationInputValues() {
            return {
                currentAge: parseInt(document.getElementById('currentAge').value),
                annualIncome: parseFloat(document.getElementById('annualIncome').value.replace(/,/g, '')),
                currentSavings: parseFloat(document.getElementById('currentSavings').value.replace(/,/g, '')),
                monthlyContributions: parseFloat(document.getElementById('monthlyContributions').value.replace(/,/g, '')),
                retirementAge: parseInt(document.getElementById('retirementAge').value),
                preReturnRate: parseFloat(document.getElementById('preReturnRate').value) / 100,
                inflationRate: parseFloat(document.getElementById('inflationRate').value) / 100,
                incomeIncrease: parseFloat(document.getElementById('incomeIncrease').value) / 100,
                currentMonthlyExpenses: parseFloat(document.getElementById('currentMonthlyExpenses').value.replace(/,/g, ''))
            };
        }

        function getDistributionInputValues() {
            return {
                retirementSavings: parseFloat(document.getElementById('retirementSavings').value.replace(/,/g, '')),
                monthlyBudget: parseFloat(document.getElementById('currentMonthlyExpenses').value),
                monthlySocialSecurity: parseFloat(document.getElementById('monthlySocialSecurity').value.replace(/,/g, '')),
                otherIncome: parseFloat(document.getElementById('otherIncome').value.replace(/,/g, '')),
                lifeExpectancy: parseInt(document.getElementById('lifeExpectancy').value),
                postReturnRate: parseFloat(document.getElementById('postReturnRate').value) / 100,
                inflationRate: parseFloat(document.getElementById('inflationRateDistribution').value) / 100,
                retirementAge: parseInt(document.getElementById('retirementAge').value)
            };
        }

        function calculateAccumulationYearlyData(age, inputs, currentValues) {
        const { preReturnRate, inflationRate, incomeIncrease } = inputs;
        const { savings, income, contributions, currentYear } = currentValues;

        const startAmount = savings;
        const investmentIncome = savings * preReturnRate;
        const newSavings = savings + contributions + investmentIncome;
        const newIncome = income * (1 + incomeIncrease);
        const newContributions = contributions * (1 + incomeIncrease);

        return {
            year: currentYear,
            age: age,
            income: newIncome,
            contributions: newContributions,
            investmentIncome: investmentIncome,
            startAmount: startAmount,
            endAmount: newSavings
        };
    }

        function calculateDistributionYearlyData(age, inputs, currentValues) {
            const { monthlySocialSecurity, otherIncome, postReturnRate, inflationRate } = inputs;
            const { savings, currentYear } = currentValues;

            const annualExpenses = projectedMonthlyExpensesAtRetirement * 12 * Math.pow(1 + inflationRate, age - inputs.retirementAge);
            const annualSocialSecurity = monthlySocialSecurity * 12 * Math.pow(1 + inflationRate, age - inputs.retirementAge);
            const annualOtherIncome = otherIncome * 12 * Math.pow(1 + inflationRate, age - inputs.retirementAge);

            const investmentIncome = savings * postReturnRate;
            const withdrawal = Math.max(0, annualExpenses - annualSocialSecurity - annualOtherIncome);
            const remainingSavings = savings + investmentIncome - withdrawal;



            return {
                year: currentYear,
                age: age,
                expenses: annualExpenses,
                socialSecurity: annualSocialSecurity,
                otherIncome: annualOtherIncome,
                withdrawal: withdrawal,
                remainingSavings: remainingSavings
            };
        }

        function updateAccumulationChart(data) {
            const ctx = document.getElementById('accumulationChart').getContext('2d');
            
            const labels = data.map(d => d.age);
            const savings = data.map(d => d.endAmount / 1000); // Convert to thousands

            if (window.accumulationChart instanceof Chart) {
                window.accumulationChart.destroy();
            }

            window.accumulationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Retirement Savings',
                        data: savings,
                        borderColor: 'green',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Age'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Amount (thousands)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateDistributionChart(data) {
        const ctx = document.getElementById('distributionChart').getContext('2d');
        
        const labels = data.map(d => d.age);
        const savings = data.map(d => d.remainingSavings / 1000); // Convert to thousands

        if (window.distributionChart instanceof Chart) {
            window.distributionChart.destroy();
        }

        window.distributionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Remaining Savings',
                    data: savings,
                    borderColor: 'blue',
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Age'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Amount (thousands)'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }


    const currencyFormatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });

    function updateAccumulationTable(data) {
        const tbody = document.querySelector('#accumulationTable tbody');
        tbody.innerHTML = '';



        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.year}</td>
                <td>${row.age}</td>
                <td>${currencyFormatter.format(row.income)}</td>
                <td>${currencyFormatter.format(row.contributions)}</td>
                <td>${currencyFormatter.format(row.investmentIncome)}</td>
                <td>${currencyFormatter.format(row.endAmount)}</td>
            `;
            tbody.appendChild(tr);
        });
    }


        function updateDistributionTable(data) {
        const tbody = document.querySelector('#distributionTable tbody');
        tbody.innerHTML = '';


        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.year}</td>
                <td>${row.age}</td>
                <td>${currencyFormatter.format(row.expenses)}</td>
                <td>${currencyFormatter.format(row.socialSecurity)}</td>
                <td>${currencyFormatter.format(row.otherIncome)}</td>
                <td>${currencyFormatter.format(row.withdrawal)}</td>
                <td>${currencyFormatter.format(row.remainingSavings)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

        function initializeMoneyInput(input) {
            input.value = formatMoney(input.value);
            setupMoneyInputListeners(input);
        }

        function setupMoneyInputListeners(input) {
            input.addEventListener('input', function() {
                this.value = formatMoney(this.value);
            });

            input.addEventListener('blur', function() {
                this.value = formatMoney(this.value);
            });
        }

        function formatMoney(value) {
            value = value.replace(/\D/g, '');
            if (value === '') return '';
            
            return parseInt(value, 10).toLocaleString('en-US');
        }

        document.addEventListener('DOMContentLoaded', function() {
        calculateAccumulationPhase(); // Calculate accumulation phase with default values

        const moneyInputs = document.querySelectorAll('#annualIncome, #currentSavings, #monthlyContributions, #monthlyBudget, #otherIncome, #monthlySocialSecurity, #retirementSavings');
        moneyInputs.forEach(initializeMoneyInput);

        document.getElementById('accumulationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateAccumulationPhase();
        });

        document.getElementById('distributionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateDistributionPhase();
        });

        // Trigger distribution phase calculation when switching to the distribution tab
        document.querySelector('.tab[onclick="openTab(event, \'distribution\')"]').addEventListener('click', function() {
            calculateDistributionPhase();
        });
    });



    </script>
</body>
</html>